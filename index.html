<h1><strong>Project Report</strong></h1>
<h1>CS445 Final Project: Face Detection and Synthesis</h1>
<h4>Tianwei Peter Zhang (tianwei4)</h4>
<p>&nbsp;</p>
<h2>Overview:</h2>
<img src="test_img_draw/triangulation.jpg" width="256" height="256" alt="Triangulation">
<img src="test_img_avrg/final_female.jpg" width="256" height="256" alt="Final Female">
<p>The purpose of this project is to locate different faces in multiple images, warp/morph them to a certain perspective so that the facial landmarks are matched and the corresponding areas on the faces are matched. Finally, we compute the average face using the warped faces we compute and naturally blend it back to the reference plane.</p>
<p>&nbsp;</p>
<h3>(Reference image used across the whole project demo):</h3>
<p><img src="ref/ref.jpeg" width="256" height="256" alt="Ref"></p>
<h3>(Face library for demo purpose): <sub>these are all machine generated fake faces</sub></h3>
<p>
	<img src="faces/f00000.jpeg" width="256" height="256" alt="F00000">
	<img src="faces/f00001.jpeg" width="256" height="256" alt="F00001">
	<img src="faces/f00002.jpeg" width="256" height="256" alt="F00002">
	<img src="faces/f00003.jpeg" width="256" height="256" alt="F00003">
	<img src="faces/f00004.jpeg" width="256" height="256" alt="F00004">
</p>
<p>
	<img src="faces/f00005.jpeg" width="256" height="256" alt="F00005">
	<img src="faces/f00006.jpeg" width="256" height="256" alt="F00006">
	<img src="faces/f00007.jpeg" width="256" height="256" alt="F00007">
	<img src="faces/f00008.jpeg" width="256" height="256" alt="F00008">
	<img src="faces/f00009.jpeg" width="256" height="256" alt="F00009">
</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>First draft idea: global warp using key points</h2>
<p>The idea that first and easily comes to mind is to use a similar method of warping as used in our project 5 video stitching, namely to apply a detector to recognize facial landmarks on the face, calculate 4 key points based on the landmarks, and try to warp all our faces into the reference plane based on the 4 key points. However, the viability of the results can vary very drastically.</p>
<h4>4 key points: <img src="test_img_draft/4keypts.jpg" width="256" height="256" alt="4keypts"></h4>
<h4>warp result 1 (slightly bad): <img src="test_img_draft/draft_warp1.jpg" width="256" height="256" alt="Draft Warp1"></h4>
<h4>warp result 2 (very unviable): <img src="test_img_draft/draft_warp5.jpg" width="256" height="256" alt="Draft Warp5"></h4>
<p>&nbsp;</p>
<p>As shown, the results generated by this method is quite unreliable.</p>
<h4>draft blended avrg face: <img src="test_img_draft/draft_result.jpg" width="256" height="256" alt="Draft Result"></h4>
<p>I had put a lot of work and debugging into it but turned out it's really hard to get anything useful out of this method. So I have to figure out a different way of processing the warp operation.</p>
<h2>&nbsp;</h2>
<p>&nbsp;</p>
<h2>Main idea: perform triangulation on faces and warp corresponding triangles</h2>
<p>After researches I discovered a much better way of dealing with warp operations. With the facial landmarks detected, we perform&nbsp;Delaunay Triangulation among the landmark points.</p>
<h4>Facial landmark points: <img src="test_img_draw/facial_pts.jpg" width="256" height="256" alt="Facial Pts"> <img src="test_img_draw/facial_pts_1.jpg" width="256" height="256" alt="Facial Pts 1"></h4>
<p>We need to construct a convex hull first, in order to draw a mask that will fully cover all the triangles in our triangulation process.</p>
<h4>Convex hull: <img src="test_img_draw/convexhull.jpg" width="256" height="256" alt="Convexhull"> <img src="test_img_draw/convexhull_1.jpg" width="256" height="256" alt="Convexhull 1"></h4>
<h4>Masked faces: <img src="test_img_draw/mask.jpg" width="256" height="256" alt="Mask"> <img src="test_img_draw/mask_1.jpg" width="256" height="256" alt="Mask 1"></h4>
<p>Then we perform full triangulation onto the landmark points.</p>
<h4>Triangulation: <img src="test_img_draw/triangulation.jpg" width="256" height="256" alt="Triangulation"> <img src="test_img_draw/triangulation_1.jpg" width="256" height="256" alt="Triangulation 1"></h4>
<p>Note that the triangulation from our test image is different from the reference triangulation. This is because the different relative position of the landmark points renders different triangulation within the hull.</p>
<p>Instead for our test image, we need to apply the sectors exactly the same way as in our reference triangulation, in order for every section to match. To do that we construct a array to record the index of vertices of each triangles, and recover the triangles back using those indices on the target image.</p>
<p>(This is a bug that's very easy to overlook and I was literally stuck here for 2 full nights)</p>
<h4>Corrected triangulation: <img src="test_img_draw/triangulation.jpg" width="256" height="256" alt="Triangulation"> <img src="test_img_draw/triangulation_2.jpg" width="256" height="256" alt="Triangulation 2"></h4>
<p>The next step is to warp the target triangles into the perspective of the the corresponding reference triangles. For each triangle we create a mask to extract the content within the bounded rect, warp the image, then place the triangle content onto our result.&nbsp;</p>
<h4>Warped face (boundary problem): <img src="test_img_warp/warped_face1_1.jpg" width="256" height="256" alt="Warped Face1 1"></h4>

<p>We can see that the boundary values are not carried over nicely using our triangle mask due to the round of the pixel coordinate value. To fix this we create another mask to only mask out the boundaries and blend it back in.</p>

<h4>Boundary line: <img src="test_img_warp/warped_face1_lines.jpg" width="256" height="256" alt="Warped Face1 Lines"></h4>

<h4>Warped face: <img src="test_img_warp/warped_face1_3.jpg" width="256" height="256" alt="Warped Face1 3"></h4>
<p>There are still some missing values, I assume it's due to the round off error and hard to correctly optimize during our preprocess. Instead we can post process to fix it either by guessing the missing values or blur the image and let the gaussian blur insert the values for us. Since we want to blur the face after averaging anyway I chose gaussian blur to further optimize the result. I found the kernel of size 25pixel x 25pixel works nicely here.</p>
<h4>Warped face (blurred): <img src="test_img_warp/warped_face1_blur.jpg" width="256" height="256" alt="Warped Face1 Blur"></h4>
<p>&nbsp;</p>
<h2>Final step: average the face library and merge the average face onto the reference image</h2>
<p>After processing the whole library using algorithm abover we can get an array of new faces that are warped to have correct corresponding facial landmarks and perspective. Averaging the faces can be done easily using the np array reducer.</p>
<p>I precess 3 versions of the average face using a subgroup of faces in the library: all faces, female faces and male faces.</p>
<h4>Average face (order: female - all - male):</h4>
<h4><img src="test_img_avrg/avrg_female.jpg" width="256" height="256" alt="Avrg Female"> <img src="test_img_avrg/avrg.jpg" width="256" height="256" alt="Avrg"> <img src="test_img_avrg/avrg_male.jpg" width="256" height="256" alt="Avrg Male"></h4>
<p>then we blend them back into the reference face. Additionally, we apply the poisson image editing method to make the blend more natural.</p>
<h4>Blended face (order: female - all - male):</h4>
<h4><img src="test_img_avrg/final_female.jpg" width="256" height="256" alt="Final Female"> <img src="test_img_avrg/final.jpg" width="256" height="256" alt="Final"> <img src="test_img_avrg/final_male.jpg" width="256" height="256" alt="Final Male"></h4>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><sub>Outside resources and libraries:</sub></p>
<ul>
<li><sub>face_recognition library (built based on dlib): <a href="https://github.com/ageitgey/face_recognition">https://github.com/ageitgey/face_recognition</a></sub></li>
<li><sub>Face Morph Using OpenCV by&nbsp;Satya Mallick:&nbsp;<a href="https://www.learnopencv.com/face-morph-using-opencv-cpp-python">https://www.learnopencv.com/face-morph-using-opencv-cpp-python</a></sub></li>
<li><sub>this person doesn't exist dot com (generating fake faces for testing):&nbsp;</sub><sub><a href="https://thispersondoesnotexist.com/">https://thispersondoesnotexist.com/</a></sub></li>
</ul>